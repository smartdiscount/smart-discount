<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBA Smart Discount - Pro v3 (Cart & Admin Control)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- STYLES (CSS) --- */
        :root {
            --primary: #006230;
            --primary-dark: #004d26;
            --secondary: #2ECC71;
            --accent: #F2C94C;
            --bg: #F8F9FA;
            --white: #FFFFFF;
            --text: #333;
            --danger: #e74c3c;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #e0e0e0;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #app-container {
            width: 100%;
            max-width: 414px;
            background-color: var(--bg);
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
        }

        /* HEADER */
        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 18px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .logo { font-weight: 800; font-size: 1.4rem; letter-spacing: -1px; }

        .points-badge {
            background: var(--white);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .points-icon { color: var(--accent); font-size: 1.1em; }

        /* MAIN CONTENT */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 90px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0 12px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* NOTIFICATION SECTION */
        .notif-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .notif-card {
            background: linear-gradient(135deg, #fff 0%, #f0fff4 100%);
            border-left: 4px solid var(--secondary);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow);
        }
        .fav-notif {
            border-left-color: var(--accent);
            background: linear-gradient(135deg, #fff 0%, #fffbe6 100%);
        }

        /* PRODUCT CARDS */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .product-item {
            background: white; border-radius: 15px; padding: 15px; text-align: center;
            border: 1px solid #f0f0f0; box-shadow: var(--shadow); position: relative;
        }
        .old-price { text-decoration: line-through; color: #b0b0b0; font-size: 0.85rem; }
        .new-price { color: #e74c3c; font-weight: 800; font-size: 1.2rem; }
        
        /* FAVORITE BTN */
        .fav-btn {
            position: absolute; top: 10px; right: 10px; font-size: 22px; cursor: pointer; transition: 0.2s;
            background: transparent; border: none; padding: 0;
        }
        .fav-btn:hover { transform: scale(1.1); }

        /* CATEGORY CHIPS */
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 5px 2px 15px 2px; scrollbar-width: none; }
        .cat-chip {
            background: #fff; padding: 8px 18px; border-radius: 20px; font-size: 13px;
            font-weight: 600; white-space: nowrap; cursor: pointer; border: 1.5px solid #eee;
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* FARM GAME GRID */
        .farm-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .farm-slot {
            aspect-ratio: 1/1; background-color: #8D6E63; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border: 3px solid #6D4C41; transition: 0.3s; position: relative;
        }
        .farm-slot.ready { background-color: #A5D6A7; border-color: #2ECC71; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        
        .progress-container { width: 80%; height: 6px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent); border-radius: 10px; width: 0%; }

        /* MODAL */
        #seed-modal, #admin-modal, #product-detail-modal, #cart-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; display: none; align-items: center; justify-content: center;
        }
        .modal-content { 
            background: white; padding: 20px; border-radius: 20px; width: 85%; 
            text-align: center; max-width: 380px; max-height: 90vh; overflow-y: auto; 
        }
        .seed-option { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }

        /* BUTTONS */
        .add-btn {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%;
            transition: 0.2s;
        }
        .add-btn:active { transform: scale(0.98); }

        /* CART FLOATING BUTTON */
        .cart-float-btn {
            position: absolute; bottom: 80px; right: 20px; width: 60px; height: 60px;
            background: var(--accent); border-radius: 50%; display: none; /* JS will show it */
            align-items: center; justify-content: center; font-size: 30px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; cursor: pointer;
            border: 3px solid white;
        }
        .cart-badge {
            position: absolute; top: -5px; right: -5px; background: var(--danger); color: white;
            width: 24px; height: 24px; border-radius: 50%; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        /* CART MODAL ITEMS */
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .qty-controls { display: flex; align-items: center; gap: 10px; background: #f0f0f0; border-radius: 20px; padding: 2px 10px; }
        .qty-btn { font-size: 18px; font-weight: bold; cursor: pointer; color: var(--primary); user-select: none; }

        /* BOTTOM NAV */
        nav {
            background: white; border-top: 1px solid #eee; display: flex;
            justify-content: space-around; padding: 12px 0; position: absolute; bottom: 0; width: 100%; z-index: 10;
        }
        .nav-item { text-align: center; color: #aaa; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        .toast {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: 0.4s; z-index: 4000;
        }
        .toast.show { opacity: 1; }
    </style>
</head>
<body>

<div id="app-container">
    <header>
        <div class="logo">OBA</div>
        <div class="points-badge">
            <span class="points-icon">‚òÖ</span> 
            <span id="header-points">120</span>
        </div>
    </header>

    <div id="cart-float" class="cart-float-btn" onclick="openCartModal()">
        üõí
        <div class="cart-badge" id="cart-count">0</div>
    </div>

    <div id="seed-modal">
        <div class="modal-content">
            <h3>N…ô …ôkm…ôk ist…ôyirsiz?</h3>
            <p style="font-size: 12px; color: #666;">H…ôr …ôkin: 10 XP</p>
            <div id="seed-list"></div>
            <button class="add-btn" style="background: #999; margin-top:10px;" onclick="closeModal()">L…ôƒüv et</button>
        </div>
    </div>

    <div id="cart-modal">
        <div class="modal-content">
            <h3>S…ôb…ôtiniz</h3>
            <div id="cart-items" style="max-height: 300px; overflow-y:auto; margin-bottom: 15px;"></div>
            <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:10px;">
                <span>C…ômi:</span>
                <span id="cart-total">0.00 ‚Çº</span>
            </div>
            <button class="add-btn" style="margin-top:15px;" onclick="checkout()">Sifari≈üi Tamamla</button>
            <button class="add-btn" style="background: #999; margin-top:10px;" onclick="closeCartModal()">Baƒüla</button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div id="main-content"></div>

    <nav>
        <div class="nav-item active" id="nav-home" onclick="navigate('home')">
            <span class="nav-icon">üè†</span>∆èsas
        </div>
        <div class="nav-item" id="nav-shop" onclick="navigate('shop')">
            <span class="nav-icon">üõí</span>Maƒüaza
        </div>
        <div class="nav-item" id="nav-game" onclick="navigate('game')">
            <span class="nav-icon">üå±</span>Ferma
        </div>
        <div class="nav-item" id="nav-profile" onclick="navigate('profile')">
            <span class="nav-icon">üë§</span>Profil
        </div>
    </nav>
</div>

<div id="admin-container" style="display: none;">
    <div class="admin-sidebar">
        <div class="admin-logo">OBA ADMIN</div>
        <div class="admin-menu-item active" onclick="adminNav('dashboard', this)">üìä Dashboard</div>
        <div class="admin-menu-item" onclick="adminNav('shops', this)">üè™ Maƒüazalar</div>
        <div class="admin-menu-item" onclick="adminNav('products', this)">üì¶ M…ôhsullar</div>
        <div class="admin-menu-item" onclick="adminNav('games', this)">üéÆ Oyunlar</div> <div class="admin-menu-item" onclick="adminNav('users', this)">üë• ƒ∞stifad…ô√ßil…ôr</div>
        <div class="admin-menu-item logout" onclick="exitAdmin()">üö™ <span style="margin-left:5px;">√áƒ±xƒ±≈ü</span></div>
    </div>
    <div class="admin-content">
        <div class="admin-header">
            <h2 id="admin-page-title">Dashboard</h2>
            <div class="admin-user-profile">Admin (Super)</div>
        </div>
        <div id="admin-view-port">
            </div>
    </div>
</div>

<div id="admin-modal">
    <div class="modal-content">
        <h3 id="modal-title">Yeni ∆èlav…ô</h3>
        <div id="modal-body"></div>
        <button class="add-btn" style="background: #999; margin-top:10px;" onclick="closeAdminModal()">L…ôƒüv et</button>
    </div>
</div>

<div id="product-detail-modal">
    <div class="modal-content" id="product-detail-content">
        </div>
</div>

<style>
    /* Admin Layout */
    #admin-container {
        width: 100%; height: 100vh; background: #f4f6f9; position: absolute; top:0; left:0; z-index: 2000;
        display: flex; flex-direction: row; font-family: 'Segoe UI', sans-serif;
    }
    .admin-sidebar {
        width: 250px; background: #1a1a1a; color: white; display: flex; flex-direction: column; padding: 20px;
    }
    .admin-logo { font-size: 24px; font-weight: bold; color: var(--secondary); margin-bottom: 40px; text-align: center; }
    .admin-menu-item {
        padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; color: #ccc;
    }
    .admin-menu-item:hover, .admin-menu-item.active { background: var(--primary); color: white; }
    
    .admin-menu-item.logout { margin-top: auto; background: var(--danger); color: white; display: flex; justify-content: center; align-items: center; }
    
    .admin-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
    .admin-header {
        background: white; padding: 20px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;
    }
    #admin-view-port { padding: 30px; overflow-y: auto; flex: 1; }

    /* Admin Cards & Tables */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-val { font-size: 28px; font-weight: bold; color: var(--primary); margin: 10px 0; }
    .stat-label { color: #777; font-size: 14px; }
    
    .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .admin-table th, .admin-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
    .admin-table th { background: #f8f9fa; font-weight: 600; color: #555; }
    .admin-table tr:hover { background-color: #f1f1f1; cursor: pointer; }
    .banned-row { background-color: #ffebee; color: #c62828; }
    
    .btn-sm { padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; border: none; }
    .btn-green { background: var(--secondary); color: white; }
    .btn-red { background: var(--danger); color: white; }

    .form-group { margin-bottom: 15px; text-align: left; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 12px; }
    .form-group input, .form-group select { width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

    .chart-container {
        background: white; padding: 20px; border-radius: 12px; height: 300px;
    }

    .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
    .radio-group label { font-size: 14px; cursor: pointer; }

    @media (max-width: 768px) {
        #admin-container { flex-direction: column; }
        .admin-sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; box-sizing: border-box; }
        .admin-logo { display: none; }
        .admin-menu-item { padding: 10px; white-space: nowrap; font-size: 12px; }
        .admin-menu-item.logout { margin-top: 0; }
    }
</style>

<script>
    /* --- DATA STATE --- */
    let state = {
        points: 550, 
        activeTab: 'home',
        currentCategory: 'Hamƒ±sƒ±',
        selectedSlot: null,
        cart: [], // S…ôb…ôt massivi
        
        // Farm Seeds - Artƒ±q state daxilind…ôdir ki, admin d…ôyi≈ü…ô bilsin
        seeds: [
            { id: 'tomato', name: 'Pomidor', icon: 'üçÖ', time: 5, reward: 25 },
            { id: 'corn', name: 'Qarƒüƒ±dalƒ±', icon: 'üåΩ', time: 15, reward: 50 },
            { id: 'milk', name: 'S√ºd (ƒ∞n…ôk)', icon: 'üêÑ', time: 40, reward: 120 }
        ],

        farmSlots: Array(9).fill(null).map(() => ({ status: 0, product: null, progress: 0 })),
        
        shops: [
            { id: 101, name: 'OBA - N…ôrimanov', cat: 'Supermarket', rating: 4.8, forecast: 92 },
            { id: 102, name: 'OBA - G…ônclik', cat: 'Hipermarket', rating: 4.5, forecast: 88 }
        ],
        
        users: [
            { id: 1, name: 'Anar M…ômm…ôdov', balance: 120, status: 'Aktiv', isBanned: false },
            { id: 2, name: 'Leyla ∆èliyeva', balance: 450, status: 'VIP', isBanned: false },
            { id: 3, name: 'Samir Quliyev', balance: 0, status: 'Banlanƒ±b', isBanned: true }
        ],
        
        products: [
            { id: 1, name: "S√ºd 1L (Milla)", cat: "S√ºd", price: 2.50, discount: 2.10, pts: 5, icon: "ü•õ", isFav: false, type: 'Manual', stock: 50, expiryDays: 10 },
            { id: 2, name: "Lays √áips", cat: "Snack", price: 3.00, discount: 2.50, pts: 10, icon: "ü•î", isFav: false, type: 'Manual', stock: 30, expiryDays: 60 },
            { id: 3, name: "Cola 0.5L", cat: "ƒ∞√ßki", price: 1.20, discount: 1.00, pts: 2, icon: "ü•§", isFav: false, type: 'Manual', stock: 100, expiryDays: 120 }
        ]
    };

    const notifications = [
        "Siz…ô √∂z…ôl: S√ºd m…ôhsullarƒ±nda 10% …ôlav…ô xal!",
        "G√ºn√ºn f√ºrs…ôti: Banan alana 15 Oba Points!",
        "Fermadakƒ± m…ôhsullarƒ± toplamaƒüƒ± unutmayƒ±n!",
        "Yeni kampaniya: ƒ∞√ßkil…ôrd…ô 1+1 f√ºrs…ôti!"
    ];

    /* --- INITIALIZATION --- */
    window.onload = () => {
        navigate('home');
        updatePointsDisplay();
        updateCartCount();
        setInterval(updateUIProgress, 100);
    };

    function updatePointsDisplay() {
        document.getElementById('header-points').innerText = state.points;
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function navigate(pageName) {
        state.activeTab = pageName;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${pageName}`).classList.add('active');

        // Cart button visibility: Only in Shop
        const cartBtn = document.getElementById('cart-float');
        if(pageName === 'shop') cartBtn.style.display = 'flex';
        else cartBtn.style.display = 'none';

        if(pageName === 'home') renderHome();
        else if(pageName === 'shop') renderShop('Hamƒ±sƒ±');
        else if(pageName === 'game') renderGame();
        else if(pageName === 'profile') renderProfile();
    }

    /* --- CART LOGIC --- */
    function addToCart(prodId) {
        const prod = state.products.find(p => p.id === prodId);
        
        // Stock check UI side (optional, strict check is at checkout)
        if(prod.stock <= 0) return showToast("Bu m…ôhsul bitib!");

        const existing = state.cart.find(item => item.id === prodId);
        if(existing) {
            existing.qty++;
        } else {
            state.cart.push({ id: prodId, qty: 1, name: prod.name, price: prod.discount });
        }
        
        updateCartCount();
        showToast("S…ôb…ôt…ô …ôlav…ô olundu!");
    }

    function updateCartCount() {
        const count = state.cart.reduce((sum, item) => sum + item.qty, 0);
        document.getElementById('cart-count').innerText = count;
    }

    function openCartModal() {
        const modal = document.getElementById('cart-modal');
        const container = document.getElementById('cart-items');
        modal.style.display = 'flex';
        renderCartItems();
    }

    function renderCartItems() {
        const container = document.getElementById('cart-items');
        if(state.cart.length === 0) {
            container.innerHTML = "<p style='color:#777;'>S…ôb…ôtiniz bo≈üdur</p>";
            document.getElementById('cart-total').innerText = "0.00 ‚Çº";
            return;
        }

        let total = 0;
        container.innerHTML = state.cart.map(item => {
            total += item.price * item.qty;
            return `
                <div class="cart-item">
                    <div style="text-align:left;">
                        <div style="font-weight:bold; font-size:14px;">${item.name}</div>
                        <div style="font-size:12px; color:#666;">${item.price.toFixed(2)} ‚Çº</div>
                    </div>
                    <div class="qty-controls">
                        <span class="qty-btn" onclick="updateCartQty(${item.id}, -1)">-</span>
                        <span style="font-size:14px; margin:0 5px;">${item.qty}</span>
                        <span class="qty-btn" onclick="updateCartQty(${item.id}, 1)">+</span>
                    </div>
                </div>
            `;
        }).join('');
        document.getElementById('cart-total').innerText = total.toFixed(2) + " ‚Çº";
    }

    function updateCartQty(id, change) {
        const item = state.cart.find(x => x.id === id);
        if(item) {
            item.qty += change;
            if(item.qty <= 0) {
                state.cart = state.cart.filter(x => x.id !== id);
            }
            renderCartItems();
            updateCartCount();
        }
    }

    function closeCartModal() { document.getElementById('cart-modal').style.display = 'none'; }

    function checkout() {
        if(state.cart.length === 0) return showToast("S…ôb…ôt bo≈üdur!");

        // Stock Validation & Reduction Logic
        let error = false;
        
        // Check availability first
        for(let item of state.cart) {
            const prod = state.products.find(p => p.id === item.id);
            if(!prod || prod.stock < item.qty) {
                alert(`"${item.name}" m…ôhsulundan stokda kifay…ôt q…ôd…ôr yoxdur! (Qalƒ±q: ${prod ? prod.stock : 0})`);
                error = true;
                break;
            }
        }

        if(!error) {
            // Deduct stock
            state.cart.forEach(item => {
                const prod = state.products.find(p => p.id === item.id);
                if(prod) {
                    prod.stock -= item.qty;
                }
            });

            state.cart = [];
            updateCartCount();
            closeCartModal();
            showToast("Sifari≈ü uƒüurla tamamlandƒ±! ‚úÖ");
            
            // If we are on shop page, re-render to potentially show out of stock items
            if(state.activeTab === 'shop') renderShop(state.currentCategory);
        }
    }


    /* --- RENDERING FUNCTIONS (APP) --- */

    function renderHome() {
        const container = document.getElementById('main-content');
        
        const favProducts = state.products.filter(p => p.isFav);
        let dynamicNotifs = [...notifications];
        
        if (favProducts.length > 0) {
            favProducts.forEach(p => {
                dynamicNotifs.unshift(`‚ù§Ô∏è Sevimli m…ôhsulunuz "${p.name}" endirimd…ôdir!`);
            });
        }
        const displayNotifs = dynamicNotifs.slice(0, 3);

        const randomProduct = state.products[Math.floor(Math.random() * state.products.length)];
        const xpPrice = Math.floor(Math.random() * (600 - 300 + 1)) + 300;

        container.innerHTML = `
            <div class="section-title">üîî T…ôklifl…ôr</div>
            <div class="notif-container">
                ${displayNotifs.map(n => `
                    <div class="notif-card ${n.includes('Sevimli') ? 'fav-notif' : ''}">
                        <span style="font-size:1.5rem;">${n.includes('Sevimli') ? 'üòç' : 'üéÅ'}</span>
                        <div>${n}</div>
                    </div>
                `).join('')}
            </div>
            
            <div class="section-title">üî• G√ºn√ºn T…ôklifi (XP il…ô al)</div>
            <div class="product-item" style="border: 2px solid var(--accent); background: #fffbe6;">
                <span style="font-size: 50px;">${randomProduct.icon}</span>
                <h3>${randomProduct.name}</h3>
                <p>Bazar qiym…ôti: <span class="old-price">${randomProduct.price} ‚Çº</span></p>
                <p style="font-weight:bold; color: var(--primary);">Sad…ôc…ô: ${xpPrice} XP</p>
                <button class="add-btn" onclick="buyDeal(${xpPrice}, '${randomProduct.name}')">ƒ∞ndi Al (${xpPrice} XP)</button>
            </div>
        `;
    }

    function buyDeal(price, name) {
        if(state.points >= price) {
            state.points -= price;
            updatePointsDisplay();
            showToast(`T…ôbrikl…ôr! ${name} alƒ±ndƒ±.`);
        } else {
            showToast("Balansƒ±nƒ±zda kifay…ôt q…ôd…ôr XP yoxdur!");
        }
    }

    function renderShop(category) {
        state.currentCategory = category;
        const container = document.getElementById('main-content');
        const cats = ["Hamƒ±sƒ±", "S√ºd", "√á√∂r…ôk", "Snack", "ƒ∞√ßki", "Meyv…ô"];
        const filtered = category === "Hamƒ±sƒ±" ? state.products : state.products.filter(p => p.cat === category);

        container.innerHTML = `
            <div class="category-scroll">
                ${cats.map(c => `<div class="cat-chip ${state.currentCategory===c?'active':''}" onclick="renderShop('${c}')">${c}</div>`).join('')}
            </div>
            <div class="product-grid" style="padding-bottom: 50px;">
                ${filtered.map(p => `
                    <div class="product-item" style="${p.stock <= 0 ? 'opacity:0.6;' : ''}">
                        <button class="fav-btn" onclick="toggleFavorite(${p.id})">${p.isFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                        <div style="font-size:35px">${p.icon}</div>
                        <div style="font-weight:700; font-size:0.85rem; height:30px;">${p.name}</div>
                        <div><span class="old-price">${p.price.toFixed(2)}</span> <span class="new-price">${p.discount.toFixed(2)} ‚Çº</span></div>
                        <div style="font-size:11px; color:#666; margin: 5px 0;">Stok: ${p.stock}</div>
                        <button class="add-btn" 
                            style="margin-top:5px; font-size:0.75rem; background: ${p.stock <= 0 ? '#999' : ''}" 
                            onclick="${p.stock > 0 ? `addToCart(${p.id})` : ''}">
                            ${p.stock > 0 ? 'S…ôb…ôt…ô At üõí' : 'Bitib ‚ùå'}
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    function renderGame() {
        const container = document.getElementById('main-content');
        container.innerHTML = `
            <div style="background: var(--primary); color: white; padding: 15px; border-radius: 15px; text-align: center;">
                <h2 style="margin:0;">Endirim Ferma</h2>
                <p style="font-size: 12px;">M…ôhsul …ôk, Oba Points qazan!</p>
            </div>
            <div class="farm-grid" id="farm-grid"></div>
        `;
        updateGrid();
    }

    function renderProfile() {
        const container = document.getElementById('main-content');
        container.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <div style="width:70px; height:70px; background:#ddd; border-radius:50%; margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:30px;">üë§</div>
                <h3>M√º≈üt…ôri Adƒ±</h3>
                <p style="color:var(--primary); font-weight:bold;">Green Shopper (Lv. 3)</p>
                <div style="text-align:left; background:white; padding:15px; border-radius:10px; margin-top:20px;">
                    <p>üì± Telefon: +994 50 123 45 67</p>
                    <p>üí≥ Balans: ${state.points} XP</p>
                </div>
                <button class="add-btn" style="background:#e74c3c; margin-top:20px;" onclick="alert('√áƒ±xƒ±≈ü edildi')">√áƒ±xƒ±≈ü</button>
                <button class="add-btn" style="background:#333; margin-top:10px;" onclick="openAdminPanel()">üîß Admin Paneli</button>
            </div>
        `;
    }

    /* --- LOGIC HELPERS --- */

    function toggleFavorite(id) {
        const product = state.products.find(p => p.id === id);
        if (product) {
            product.isFav = !product.isFav;
            renderShop(state.currentCategory);
            if(product.isFav) showToast(`${product.name} sevimlil…ôr…ô …ôlav…ô olundu!`);
        }
    }

    function updateGrid() {
        const grid = document.getElementById('farm-grid');
        if(!grid) return;
        grid.innerHTML = '';
        state.farmSlots.forEach((slot, i) => {
            const div = document.createElement('div');
            div.className = `farm-slot ${slot.status === 2 ? 'ready' : ''}`;
            div.onclick = () => handleSlotClick(i);
            if(slot.status === 0) div.innerHTML = "üü´";
            else if(slot.status === 1) div.innerHTML = `<span>${slot.product.icon}</span><div class="progress-container"><div class="progress-fill" id="progress-${i}" style="width:${slot.progress}%"></div></div>`;
            else if(slot.status === 2) div.innerHTML = `<span>${slot.product.icon}</span><b style="font-size:10px; color:#006230;">YIƒû!</b>`;
            grid.appendChild(div);
        });
    }

    function handleSlotClick(i) {
        const slot = state.farmSlots[i];
        if(slot.status === 0) openPlantMenu(i);
        else if(slot.status === 2) harvest(i);
    }

    function openPlantMenu(i) {
        if(state.points < 10) return showToast("Xal √ßatmƒ±r!");
        state.selectedSlot = i;
        const modal = document.getElementById('seed-modal');
        const list = document.getElementById('seed-list');
        modal.style.display = 'flex';
        list.innerHTML = state.seeds.map(s => `
            <div class="seed-option" onclick="plant('${s.id}')">
                <span>${s.icon} ${s.name} (${s.time} san)</span>
                <span style="color:var(--secondary);">+${s.reward} XP</span>
            </div>
        `).join('');
    }

    function closeModal() { document.getElementById('seed-modal').style.display = 'none'; }

    function plant(seedId) {
        const seed = state.seeds.find(s => s.id === seedId);
        const i = state.selectedSlot;
        state.points -= 10;
        updatePointsDisplay();
        state.farmSlots[i] = { status: 1, product: seed, progress: 0, startTime: Date.now(), endTime: Date.now() + (seed.time*1000) };
        closeModal();
        updateGrid();
    }

    function updateUIProgress() {
        state.farmSlots.forEach((slot, i) => {
            if(slot.status === 1) {
                let percent = ((Date.now() - slot.startTime) / (slot.endTime - slot.startTime)) * 100;
                if(percent >= 100) { slot.status = 2; updateGrid(); }
                else {
                    slot.progress = percent;
                    const bar = document.getElementById(`progress-${i}`);
                    if(bar) bar.style.width = percent + "%";
                }
            }
        });
    }

    function harvest(i) {
        state.points += parseInt(state.farmSlots[i].product.reward);
        updatePointsDisplay();
        showToast(`Yƒ±ƒüƒ±ldƒ±! +${state.farmSlots[i].product.reward} XP`);
        state.farmSlots[i] = { status: 0, product: null, progress: 0 };
        updateGrid();
    }

    /* ------------------------------------------------------------- */
    /* ADMIN PANEL JAVASCRIPT LOGIC */
    /* ------------------------------------------------------------- */

    function openAdminPanel() {
        const pass = prompt("Admin ≈ûifr…ôsi (admin):");
        if(pass === 'admin') {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('admin-container').style.display = 'flex';
            adminNav('dashboard', document.querySelector('.admin-menu-item.active'));
        } else {
            alert("Yanlƒ±≈ü ≈üifr…ô!");
        }
    }

    function exitAdmin() {
        document.getElementById('admin-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        renderHome();
    }

    function adminNav(page, el) {
        document.querySelectorAll('.admin-menu-item').forEach(e => e.classList.remove('active'));
        if(el) el.classList.add('active');

        const title = document.getElementById('admin-page-title');
        const view = document.getElementById('admin-view-port');

        if (page === 'dashboard') {
            title.innerText = "Dashboard";
            view.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Toplam Stok</div>
                        <div class="stat-val">${state.products.reduce((acc,p) => acc + p.stock, 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">G…ôlir (Bu g√ºn)</div>
                        <div class="stat-val">3,240 ‚Çº</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktiv Endiriml…ôr</div>
                        <div class="stat-val">${state.products.length}</div>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Satƒ±≈ü Statistikasƒ±</h3>
                    <div style="height: 220px; position:relative;">
                        <canvas id="revChart"></canvas>
                    </div>
                </div>
            `;
            setTimeout(initChart, 100);
        }
        else if (page === 'shops') {
            title.innerText = "Maƒüaza ƒ∞dar…ô√ßiliyi";
            let shopRows = state.shops.map(shop => `
                <tr>
                    <td>#${shop.id}</td>
                    <td>${shop.name}</td>
                    <td>${shop.cat}</td>
                    <td>‚≠ê ${shop.rating}</td>
                    <td>
                        <div style="width:100px; height:8px; background:#ddd; border-radius:5px; display:inline-block; margin-right:5px;">
                            <div style="width:${shop.forecast}%; height:100%; background:${shop.forecast>90?'#2ECC71':'#F2C94C'}; border-radius:5px;"></div>
                        </div>
                        <small>${shop.forecast}%</small>
                    </td>
                </tr>
            `).join('');

            view.innerHTML = `
                <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                    <button class="add-btn" style="width:auto;" onclick="openAddShopModal()">+ Yeni Maƒüaza</button>
                </div>
                <table class="admin-table">
                    <thead><tr><th>ID</th><th>Maƒüaza</th><th>Kateqoriya</th><th>Reytinq</th><th>Satƒ±≈ü Proqnozu</th></tr></thead>
                    <tbody>${shopRows}</tbody>
                </table>
            `;
        }
        else if (page === 'products') {
            title.innerText = "M…ôhsul ƒ∞dar…ô√ßiliyi";
            
            let productRows = state.products.map(p => `
                <tr onclick="viewProductDetails(${p.id})">
                    <td>${p.icon} ${p.name}</td>
                    <td>${p.price.toFixed(2)} ‚Çº</td>
                    <td>${p.cat}</td>
                    <td style="color:${p.stock<5?'red':'black'}">${p.stock} …ôd…ôd</td>
                    <td>${p.expiryDays} g√ºn</td>
                </tr>
            `).join('');

            view.innerHTML = `
                <div style="margin-bottom:20px;">
                    <button class="add-btn" style="width:100%;" onclick="openAdminProductModal()">+ Yeni M…ôhsul ∆èlav…ô Et</button>
                </div>
                <div style="background:white; border-radius:10px; padding:10px;">
                    <table class="admin-table">
                        <thead><tr><th>Ad</th><th>Qiym…ôt</th><th>Kateqoriya</th><th>Stok</th><th>Bitm…ôy…ô Qalƒ±b</th></tr></thead>
                        <tbody>${productRows}</tbody>
                    </table>
                </div>
            `;
        }
        else if (page === 'games') {
            title.innerText = "Oyun T…ônziml…ôm…ôl…ôri (Ferma)";
            
            let seedRows = state.seeds.map((s, idx) => `
                <tr>
                    <td>${s.icon} ${s.name}</td>
                    <td><input type="number" id="seed-time-${idx}" value="${s.time}" style="width:50px; padding:5px; border-radius:5px; border:1px solid #ddd;"> san</td>
                    <td><input type="number" id="seed-reward-${idx}" value="${s.reward}" style="width:50px; padding:5px; border-radius:5px; border:1px solid #ddd;"> XP</td>
                    <td><button class="btn-sm btn-green" onclick="saveSeedConfig(${idx})">Yadda Saxla</button></td>
                </tr>
            `).join('');

            view.innerHTML = `
                <div class="stat-card">
                    <h4>M…ôhsul Yeti≈üdirm…ô Parametrl…ôri</h4>
                    <p style="color:#666; font-size:12px; margin-bottom:15px;">M√º≈üt…ôril…ôrin yeti≈üdirdiyi m…ôhsullarƒ±n zamanƒ±nƒ± v…ô qazancƒ±nƒ± d…ôyi≈üin.</p>
                    <table class="admin-table">
                        <thead><tr><th>M…ôhsul</th><th>M√ºdd…ôt (san)</th><th>M√ºkafat (XP)</th><th>∆èm…ôliyyat</th></tr></thead>
                        <tbody>${seedRows}</tbody>
                    </table>
                </div>
            `;
        }
        else if (page === 'users') {
            title.innerText = "ƒ∞stifad…ô√ßil…ôr";
            let userRows = state.users.map(u => `
                <tr class="${u.isBanned ? 'banned-row' : ''}">
                    <td>${u.name}</td>
                    <td>${u.balance} Pts</td>
                    <td>
                        <button class="btn-sm ${u.isBanned ? 'btn-green' : 'btn-red'}" onclick="toggleBan(${u.id})">
                            ${u.isBanned ? 'Bani A√ß' : 'Banla'}
                        </button>
                    </td>
                </tr>
            `).join('');

            view.innerHTML = `
                <table class="admin-table">
                    <thead><tr><th>Ad</th><th>Balans</th><th>∆èm…ôliyyat</th></tr></thead>
                    <tbody>${userRows}</tbody>
                </table>
            `;
        }
    }

    /* --- ADMIN ACTION FUNCTIONS --- */

    function saveSeedConfig(idx) {
        const timeInput = document.getElementById(`seed-time-${idx}`).value;
        const rewardInput = document.getElementById(`seed-reward-${idx}`).value;
        
        state.seeds[idx].time = parseInt(timeInput);
        state.seeds[idx].reward = parseInt(rewardInput);
        alert(`${state.seeds[idx].name} parametrl…ôri yenil…ôndi!`);
    }

    // Chart Fix
    function initChart() {
        const ctx = document.getElementById('revChart');
        if(ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['B.E', '√á.A', '√á', 'C.A', 'C', '≈û', 'B'],
                    datasets: [{
                        label: 'G…ôlir (AZN)',
                        data: [1200, 1900, 3000, 500, 2000, 3240, 3500],
                        borderColor: '#006230',
                        backgroundColor: 'rgba(0, 98, 48, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
        }
    }

    // Add New Shop
    function openAddShopModal() {
        document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Yeni Maƒüaza ∆èlav…ô Et";
        document.getElementById('modal-body').innerHTML = `
            <div class="form-group"><label>Maƒüaza Adƒ±</label><input id="new-shop-name" type="text" value="OBA - "></div>
            <div class="form-group"><label>Kateqoriya</label><input id="new-shop-cat" type="text" value="Market"></div>
            <button class="add-btn" onclick="saveNewShop()">∆èlav…ô Et</button>
        `;
    }

    function saveNewShop() {
        const name = document.getElementById('new-shop-name').value;
        const cat = document.getElementById('new-shop-cat').value;
        const forecast = Math.floor(Math.random() * (99 - 85) + 85); 
        state.shops.push({ id: 100 + state.shops.length + 1, name: name, cat: cat, rating: 5.0, forecast: forecast });
        closeAdminModal();
        adminNav('shops', null);
    }

    function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }
    function closeProductDetail() { document.getElementById('product-detail-modal').style.display = 'none'; }

    // User Ban System
    function toggleBan(userId) {
        const user = state.users.find(u => u.id === userId);
        if(user) {
            user.isBanned = !user.isBanned;
            adminNav('users', null);
        }
    }

    // 4. PRODUCT MANAGEMENT LOGIC
    
    // Open Modal for New Product
    function openAdminProductModal() {
        document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Yeni M…ôhsul ∆èlav…ô Et";
        document.getElementById('modal-body').innerHTML = `
            <div class="form-group"><label>M…ôhsul Adƒ±</label><input type="text" id="p-name" placeholder="M…ôs: Snickers"></div>
            <div class="form-group"><label>Kateqoriya</label><select id="p-cat"><option>Snack</option><option>S√ºd</option><option>ƒ∞√ßki</option><option>√á√∂r…ôk</option><option>Meyv…ô</option></select></div>
            <div class="form-group"><label>ƒ∞kon</label><select id="p-icon"><option>üç´</option><option>üç™</option><option>üçï</option><option>ü•©</option><option>ü•§</option><option>ü•í</option><option>üçè</option></select></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Stok (Say)</label><input type="number" id="p-stock" value="50"></div>
                <div class="form-group"><label>Son Tarix (G√ºn)</label><input type="number" id="p-expiry" value="30"></div>
            </div>

            <div class="form-group"><label>Qiym…ôt (‚Çº)</label><input type="number" id="p-price" step="0.1" placeholder="1.50"></div>
            
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <h4 style="margin:5px 0 10px 0;">Endirim ƒ∞dar…ôetm…ôsi</h4>
            
            <div class="radio-group">
                <label><input type="radio" name="discType" value="manual" checked onchange="toggleDiscInputs()"> Manual</label>
                <label><input type="radio" name="discType" value="ai" onchange="toggleDiscInputs()"> AI (Avto)</label>
            </div>

            <div id="manual-inputs">
                <div class="form-group"><label>Endirimli Qiym…ôt (‚Çº)</label><input type="number" id="p-disc-price" step="0.1"></div>
            </div>

            <div id="ai-inputs" style="display:none;">
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group"><label>Min Endirim (%)</label><input type="number" id="ai-min" placeholder="10"></div>
                    <div class="form-group"><label>Max Endirim (%)</label><input type="number" id="ai-max" placeholder="50"></div>
                </div>
                <div style="font-size:11px; color:#666; margin-bottom:5px;">Bitm…ô vaxtƒ± T1-d…ôn ki√ßik, T2-d…ôn b√∂y√ºk olarsa MIN, T2-d…ôn ki√ßik olarsa MAX endirim.</div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div class="form-group"><label>D…ôy…ôr 1 (T1 G√ºn)</label><input type="number" id="ai-t1" placeholder="M…ôs: 10"></div>
                    <div class="form-group"><label>D…ôy…ôr 2 (T2 G√ºn)</label><input type="number" id="ai-t2" placeholder="M…ôs: 3"></div>
                </div>
            </div>

            <button class="add-btn" onclick="saveProduct()">Yarat v…ô ∆èlav…ô Et</button>
        `;
    }

    function toggleDiscInputs() {
        const type = document.querySelector('input[name="discType"]:checked').value;
        document.getElementById('manual-inputs').style.display = type === 'manual' ? 'block' : 'none';
        document.getElementById('ai-inputs').style.display = type === 'ai' ? 'block' : 'none';
    }

    function saveProduct() {
        const name = document.getElementById('p-name').value;
        const cat = document.getElementById('p-cat').value;
        const icon = document.getElementById('p-icon').value;
        const price = parseFloat(document.getElementById('p-price').value);
        const discType = document.querySelector('input[name="discType"]:checked').value;
        
        // Manual Stock and Expiry Control
        const stockInput = parseInt(document.getElementById('p-stock').value) || 0;
        const expiryInput = parseInt(document.getElementById('p-expiry').value) || 0;

        if(!name || !price) return alert("Ad v…ô Qiym…ôt m√ºtl…ôqdir!");

        let finalDiscountPrice = price;
        let aiConfig = null;

        if (discType === 'manual') {
            const manualDisc = parseFloat(document.getElementById('p-disc-price').value);
            if(manualDisc) finalDiscountPrice = manualDisc;
        } else {
            // AI Logic Validation
            const minP = parseInt(document.getElementById('ai-min').value) || 0;
            const maxP = parseInt(document.getElementById('ai-max').value) || 0;
            const t1 = parseInt(document.getElementById('ai-t1').value) || 0;
            const t2 = parseInt(document.getElementById('ai-t2').value) || 0;

            if (t2 >= t1) {
                alert("X…ôta: 2-ci d…ôy…ôr (T2) 1-ci d…ôy…ôrd…ôn (T1) h…ômi≈ü…ô ki√ßik olmalƒ±dƒ±r!");
                return;
            }

            aiConfig = { min: minP, max: maxP, t1: t1, t2: t2 };

            // Apply AI Logic using MANUAL expiry input
            let appliedPercent = 0;
            if (expiryInput < t1 && expiryInput > t2) {
                appliedPercent = minP;
            } else if (expiryInput <= t2) {
                appliedPercent = maxP;
            }
            
            finalDiscountPrice = price - (price * (appliedPercent / 100));
        }

        const newProd = {
            id: Date.now(),
            name: name,
            cat: cat,
            price: price,
            discount: finalDiscountPrice,
            pts: 5,
            icon: icon,
            isFav: false,
            stock: stockInput, // Admin controlled
            expiryDays: expiryInput, // Admin controlled
            type: discType,
            aiConfig: aiConfig
        };

        state.products.push(newProd);
        closeAdminModal();
        adminNav('products', null);
        showToast("M…ôhsul uƒüurla yaradƒ±ldƒ±!");
    }

    function viewProductDetails(id) {
        const p = state.products.find(x => x.id === id);
        if(!p) return;

        const modal = document.getElementById('product-detail-modal');
        const content = document.getElementById('product-detail-content');
        
        modal.style.display = 'flex';
        
        let aiInfo = '';
        if(p.type === 'ai' && p.aiConfig) {
            aiInfo = `
                <div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-top:10px; text-align:left;">
                    <strong>ü§ñ AI Parametrl…ôri:</strong><br>
                    T1 (Ba≈ülanƒüƒ±c): ${p.aiConfig.t1} g√ºn<br>
                    T2 (Kritik): ${p.aiConfig.t2} g√ºn<br>
                    Min Endirim: ${p.aiConfig.min}%<br>
                    Max Endirim: ${p.aiConfig.max}%
                </div>
            `;
        }

        content.innerHTML = `
            <div style="font-size:40px;">${p.icon}</div>
            <h2>${p.name}</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left; margin-bottom:15px;">
                <div><strong>Kateqoriya:</strong> ${p.cat}</div>
                <div><strong>Stok:</strong> ${p.stock} …ôd…ôd</div>
                <div><strong>Son Tarix:</strong> ${p.expiryDays} g√ºn qalƒ±b</div>
                <div><strong>∆èsas Qiym…ôt:</strong> ${p.price} ‚Çº</div>
                <div><strong>Satƒ±≈ü Qiym…ôti:</strong> <span style="color:red; font-weight:bold;">${p.discount.toFixed(2)} ‚Çº</span></div>
                <div><strong>Endirim N√∂v√º:</strong> ${p.type.toUpperCase()}</div>
            </div>
            ${aiInfo}
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="add-btn" style="background:#999;" onclick="closeProductDetail()">Baƒüla</button>
                <button class="add-btn" style="background:var(--danger);" onclick="deleteProduct(${p.id})">Sil üóëÔ∏è</button>
            </div>
        `;
    }

    function deleteProduct(id) {
        if(confirm("Bu m…ôhsulu silm…ôk ist…ôdiyiniz…ô …ôminsiniz?")) {
            state.products = state.products.filter(p => p.id !== id);
            closeProductDetail();
            adminNav('products', null);
            showToast("M…ôhsul silindi.");
        }
    }

</script>
</body>
</html>