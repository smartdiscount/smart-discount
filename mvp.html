<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBA Smart Discount - Pro v6 (Analytics & Security)</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- STYLES (CSS) --- */
        :root {
            --primary: #006230;
            --primary-dark: #004d26;
            --secondary: #2ECC71;
            --accent: #F2C94C;
            --bg: #F8F9FA;
            --white: #FFFFFF;
            --text: #333;
            --danger: #e74c3c;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        body {
            font-family: 'Inter', 'Segoe UI', sans-serif;
            background-color: #e0e0e0;
            margin: 0;
            display: flex;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        #app-wrapper {
            width: 100%;
            max-width: 414px;
            background-color: var(--bg);
            height: 100%;
            position: relative;
            box-shadow: 0 0 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        /* AUTH SCREEN */
        #auth-container {
            width: 100%; height: 100%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            background: var(--primary); color: white;
            padding: 30px; box-sizing: border-box;
            z-index: 5000; position: absolute; top: 0; left: 0;
        }
        .auth-box {
            background: white; color: #333; padding: 25px;
            border-radius: 20px; width: 100%; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
        }
        .auth-input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ddd; border-radius: 10px;
            box-sizing: border-box; font-size: 16px;
        }

        /* MAIN APP */
        #app-container {
            width: 100%; height: 100%;
            display: none; /* Initially hidden */
            flex-direction: column;
        }

        /* HEADER */
        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 18px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .logo { font-weight: 800; font-size: 1.4rem; letter-spacing: -1px; }

        .points-badge {
            background: var(--white);
            color: var(--primary);
            padding: 6px 14px;
            border-radius: 25px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .points-icon { color: var(--accent); font-size: 1.1em; }

        /* MAIN CONTENT */
        #main-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 90px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            margin: 20px 0 12px 0;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* NOTIFICATION SECTION */
        .notif-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .notif-card {
            background: linear-gradient(135deg, #fff 0%, #f0fff4 100%);
            border-left: 4px solid var(--secondary);
            padding: 12px 15px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            gap: 12px;
            box-shadow: var(--shadow);
        }
        .fav-notif {
            border-left-color: var(--accent);
            background: linear-gradient(135deg, #fff 0%, #fffbe6 100%);
        }
        .hot-notif {
            border-left-color: #e74c3c;
            background: linear-gradient(135deg, #fff 0%, #ffe6e6 100%);
        }

        /* PRODUCT CARDS */
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .product-item {
            background: white; border-radius: 15px; padding: 15px; text-align: center;
            border: 1px solid #f0f0f0; box-shadow: var(--shadow); position: relative;
        }
        .old-price { text-decoration: line-through; color: #b0b0b0; font-size: 0.85rem; }
        .new-price { color: #e74c3c; font-weight: 800; font-size: 1.2rem; }
        
        /* FAVORITE BTN */
        .fav-btn {
            position: absolute; top: 10px; right: 10px; font-size: 22px; cursor: pointer; transition: 0.2s;
            background: transparent; border: none; padding: 0;
        }
        .fav-btn:hover { transform: scale(1.1); }

        /* CATEGORY CHIPS */
        .category-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 5px 2px 15px 2px; scrollbar-width: none; }
        .cat-chip {
            background: #fff; padding: 8px 18px; border-radius: 20px; font-size: 13px;
            font-weight: 600; white-space: nowrap; cursor: pointer; border: 1.5px solid #eee;
        }
        .cat-chip.active { background: var(--primary); color: white; border-color: var(--primary); }

        /* FARM GAME GRID */
        .farm-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 15px; }
        .farm-slot {
            aspect-ratio: 1/1; background-color: #8D6E63; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; border: 3px solid #6D4C41; transition: 0.3s; position: relative;
        }
        .farm-slot.ready { background-color: #A5D6A7; border-color: #2ECC71; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% {transform: scale(1);} 50% {transform: scale(1.05);} 100% {transform: scale(1);} }
        
        .progress-container { width: 80%; height: 6px; background: rgba(0,0,0,0.2); border-radius: 10px; margin-top: 8px; }
        .progress-fill { height: 100%; background: var(--accent); border-radius: 10px; width: 0%; }

        /* MODAL */
        #seed-modal, #admin-modal, #product-detail-modal, #cart-modal, #user-detail-modal {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 3000; display: none; align-items: center; justify-content: center;
        }
        .modal-content { 
            background: white; padding: 20px; border-radius: 20px; width: 85%; 
            text-align: center; max-width: 380px; max-height: 90vh; overflow-y: auto; 
        }
        .seed-option { display: flex; align-items: center; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }

        /* BUTTONS */
        .add-btn {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white; border: none; padding: 10px 18px; border-radius: 12px; font-weight: 700; cursor: pointer; width: 100%;
            transition: 0.2s;
        }
        .add-btn:active { transform: scale(0.98); }
        
        /* CART FLOATING BUTTON */
        .cart-float-btn {
            position: absolute; bottom: 80px; right: 20px; width: 60px; height: 60px;
            background: var(--accent); border-radius: 50%; display: none; /* JS will show it */
            align-items: center; justify-content: center; font-size: 30px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 100; cursor: pointer;
            border: 3px solid white;
        }
        .cart-badge {
            position: absolute; top: -5px; right: -5px; background: var(--danger); color: white;
            width: 24px; height: 24px; border-radius: 50%; font-size: 12px; font-weight: bold;
            display: flex; align-items: center; justify-content: center;
        }

        /* CART MODAL ITEMS */
        .cart-item { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding: 10px 0; }
        .qty-controls { display: flex; align-items: center; gap: 10px; background: #f0f0f0; border-radius: 20px; padding: 2px 10px; }
        .qty-btn { font-size: 18px; font-weight: bold; cursor: pointer; color: var(--primary); user-select: none; }

        /* BOTTOM NAV */
        nav {
            background: white; border-top: 1px solid #eee; display: flex;
            justify-content: space-around; padding: 12px 0; position: absolute; bottom: 0; width: 100%; z-index: 10;
        }
        .nav-item { text-align: center; color: #aaa; font-size: 11px; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: 700; }
        .nav-icon { font-size: 22px; display: block; margin-bottom: 4px; }

        .toast {
            position: absolute; bottom: 100px; left: 50%; transform: translateX(-50%);
            background: #333; color: #fff; padding: 10px 20px; border-radius: 30px; opacity: 0; transition: 0.4s; z-index: 4000;
        }
        .toast.show { opacity: 1; }

        /* ADMIN SPECIFIC */
        #admin-container {
            width: 100%; height: 100vh; background: #f4f6f9; position: absolute; top:0; left:0; z-index: 2000;
            display: flex; flex-direction: row; font-family: 'Segoe UI', sans-serif;
        }
        .admin-sidebar {
            width: 250px; background: #1a1a1a; color: white; display: flex; flex-direction: column; padding: 20px;
        }
        .admin-logo { font-size: 24px; font-weight: bold; color: var(--secondary); margin-bottom: 40px; text-align: center; }
        .admin-menu-item {
            padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; margin-bottom: 5px; color: #ccc;
        }
        .admin-menu-item:hover, .admin-menu-item.active { background: var(--primary); color: white; }
        
        .admin-menu-item.logout { margin-top: auto; background: var(--danger); color: white; display: flex; justify-content: center; align-items: center; }
        
        .admin-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .admin-header {
            background: white; padding: 20px 30px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;
        }
        #admin-view-port { padding: 30px; overflow-y: auto; flex: 1; }

        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .stat-val { font-size: 28px; font-weight: bold; color: var(--primary); margin: 10px 0; }
        .stat-label { color: #777; font-size: 14px; }
        
        .admin-table { width: 100%; border-collapse: collapse; background: white; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .admin-table th, .admin-table td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        .admin-table th { background: #f8f9fa; font-weight: 600; color: #555; }
        .admin-table tr:hover { background-color: #f1f1f1; cursor: pointer; }
        .banned-row { background-color: #ffebee; color: #c62828; }
        
        .btn-sm { padding: 5px 10px; border-radius: 5px; font-size: 12px; cursor: pointer; border: none; }
        .btn-green { background: var(--secondary); color: white; }
        .btn-red { background: var(--danger); color: white; }

        .form-group { margin-bottom: 15px; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; font-size: 12px; }
        .form-group input, .form-group select { width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; }

        .chart-container { background: white; padding: 20px; border-radius: 12px; height: 300px; }

        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-group label { font-size: 14px; cursor: pointer; }

        .ai-tier-row {
            display: grid; grid-template-columns: 1fr 1fr 40px; gap: 10px; align-items: end; margin-bottom: 10px;
            background: #f9f9f9; padding: 8px; border-radius: 6px; border: 1px solid #eee;
        }

        @media (max-width: 768px) {
            #admin-container { flex-direction: column; }
            .admin-sidebar { width: 100%; height: auto; flex-direction: row; overflow-x: auto; padding: 10px; box-sizing: border-box; }
            .admin-logo { display: none; }
            .admin-menu-item { padding: 10px; white-space: nowrap; font-size: 12px; }
            .admin-menu-item.logout { margin-top: 0; }
        }
    </style>
</head>
<body>

<div id="app-wrapper">
    
    <div id="auth-container">
        <div class="logo" style="margin-bottom: 20px; font-size: 3rem;">OBA</div>
        <div class="auth-box">
            <h3>Xo≈ü g…ôlmisiniz!</h3>
            <p style="font-size: 12px; color: #777;">Davam etm…ôk √º√ß√ºn qeydiyyatdan ke√ßin</p>
            <input type="text" id="reg-name" class="auth-input" placeholder="Adƒ±nƒ±z">
            <input type="text" id="reg-surname" class="auth-input" placeholder="Soyadƒ±nƒ±z">
            <input type="tel" id="reg-phone" class="auth-input" placeholder="+994 (XX) XXX XX XX" oninput="formatPhone(this)">
            <input type="password" id="reg-pass" class="auth-input" placeholder="≈ûifr…ô t…ôyin edin">
            <button class="add-btn" style="margin-top: 10px;" onclick="registerUser()">Daxil Ol / Qeydiyyat</button>
        </div>
    </div>

    <div id="app-container">
        <header>
            <div class="logo">OBA</div>
            <div class="points-badge">
                <span class="points-icon">‚òÖ</span> 
                <span id="header-points">0</span>
            </div>
        </header>

        <div id="cart-float" class="cart-float-btn" onclick="openCartModal()">
            üõí
            <div class="cart-badge" id="cart-count">0</div>
        </div>

        <div id="seed-modal">
            <div class="modal-content">
                <h3>N…ô …ôkm…ôk ist…ôyirsiz?</h3>
                <p style="font-size: 12px; color: #666;">H…ôr …ôkin: 10 XP</p>
                <div id="seed-list"></div>
                <button class="add-btn" style="background: #999; margin-top:10px;" onclick="closeModal()">L…ôƒüv et</button>
            </div>
        </div>

        <div id="cart-modal">
            <div class="modal-content">
                <h3>S…ôb…ôtiniz</h3>
                <div id="cart-items" style="max-height: 300px; overflow-y:auto; margin-bottom: 15px;"></div>
                <div style="display:flex; justify-content:space-between; font-weight:bold; margin-top:10px;">
                    <span>C…ômi:</span>
                    <span id="cart-total">0.00 ‚Çº</span>
                </div>
                <button class="add-btn" style="margin-top:15px;" onclick="checkout()">Sifari≈üi Tamamla</button>
                <button class="add-btn" style="background: #999; margin-top:10px;" onclick="closeCartModal()">Baƒüla</button>
            </div>
        </div>

        <div id="toast" class="toast"></div>

        <div id="main-content"></div>

        <nav>
            <div class="nav-item active" id="nav-home" onclick="navigate('home')">
                <span class="nav-icon">üè†</span>∆èsas
            </div>
            <div class="nav-item" id="nav-shop" onclick="navigate('shop')">
                <span class="nav-icon">üõí</span>Maƒüaza
            </div>
            <div class="nav-item" id="nav-game" onclick="navigate('game')">
                <span class="nav-icon">üå±</span>Ferma
            </div>
            <div class="nav-item" id="nav-profile" onclick="navigate('profile')">
                <span class="nav-icon">üë§</span>Profil
            </div>
        </nav>
    </div>
</div>

<div id="admin-container" style="display: none;">
    <div class="admin-sidebar">
        <div class="admin-logo">OBA ADMIN</div>
        <div class="admin-menu-item active" onclick="adminNav('dashboard', this)">üìä Dashboard</div>
        <div class="admin-menu-item" onclick="adminNav('shops', this)">üè™ Maƒüazalar</div>
        <div class="admin-menu-item" onclick="adminNav('products', this)">üì¶ M…ôhsullar</div>
        <div class="admin-menu-item" onclick="adminNav('games', this)">üéÆ Oyunlar</div>
        <div class="admin-menu-item" onclick="adminNav('users', this)">üë• ƒ∞stifad…ô√ßil…ôr</div>
        <div class="admin-menu-item logout" onclick="exitAdmin()">üö™ <span style="margin-left:5px;">√áƒ±xƒ±≈ü</span></div>
    </div>
    <div class="admin-content">
        <div class="admin-header">
            <h2 id="admin-page-title">Dashboard</h2>
            <div class="admin-user-profile">Admin (Super)</div>
        </div>
        <div id="admin-view-port">
            </div>
    </div>
</div>

<div id="admin-modal">
    <div class="modal-content" style="max-width: 450px;">
        <h3 id="modal-title">Yeni ∆èlav…ô</h3>
        <div id="modal-body"></div>
        <button class="add-btn" style="background: #999; margin-top:10px;" onclick="closeAdminModal()">L…ôƒüv et</button>
    </div>
</div>

<div id="product-detail-modal">
    <div class="modal-content" id="product-detail-content"></div>
</div>

<div id="user-detail-modal">
    <div class="modal-content" id="user-detail-content"></div>
</div>

<script>
    /* --- SYSTEM DATA & LOCAL STORAGE LOGIC --- */
    
    // Global App State (Loaded from LS)
    let state = {
        products: [],
        seeds: [],
        shops: [],
        users: [], 
        
        // Default Configs
        defaultSeeds: [
            { id: 101, name: 'Pomidor', icon: 'üçÖ', time: 5, reward: 25 },
            { id: 102, name: 'Qarƒüƒ±dalƒ±', icon: 'üåΩ', time: 15, reward: 50 },
            { id: 103, name: 'S√ºd (ƒ∞n…ôk)', icon: 'üêÑ', time: 40, reward: 120 }
        ],
        defaultProducts: [
            { id: 1, name: "S√ºd 1L (Milla)", cat: "S√ºd M…ôhsullarƒ±", price: 2.50, discount: 2.10, pts: 5, icon: "ü•õ", isFav: false, type: 'manual', stock: 50, expiryDays: 10, aiTiers: [] },
            { id: 2, name: "Lays √áips", cat: "Quru qida", price: 3.00, discount: 3.00, pts: 10, icon: "ü•î", isFav: false, type: 'manual', stock: 30, expiryDays: 60, aiTiers: [] },
            { id: 3, name: "Cola 0.5L", cat: "ƒ∞√ßkil…ôr", price: 1.20, discount: 1.00, pts: 2, icon: "ü•§", isFav: false, type: 'manual', stock: 100, expiryDays: 120, aiTiers: [] }
        ]
    };

    // Current User Session State
    let currentUser = null; 
    let activeTab = 'home';
    let currentCategory = 'Hamƒ±sƒ±';
    let selectedSlot = null;
    let cart = []; 

    /* --- INITIALIZATION --- */
    window.onload = () => {
        loadSystem();
        checkSession();
        setInterval(updateUIProgress, 100);
    };

    function loadSystem() {
        // Load Global Data (Admin controlled)
        const storedData = localStorage.getItem('oba_data');
        if(storedData) {
            const data = JSON.parse(storedData);
            state.products = data.products || state.defaultProducts;
            state.seeds = data.seeds || state.defaultSeeds;
            state.shops = data.shops || [];
        } else {
            state.products = state.defaultProducts;
            state.seeds = state.defaultSeeds;
            state.shops = [
                { id: 101, name: 'OBA - N…ôrimanov', cat: 'Supermarket', rating: 4.8, forecast: 92 },
                { id: 102, name: 'OBA - G…ônclik', cat: 'Hipermarket', rating: 4.5, forecast: 88 }
            ];
            saveSystem();
        }

        // Load Users
        const storedUsers = localStorage.getItem('oba_users');
        if(storedUsers) {
            state.users = JSON.parse(storedUsers);
        }
    }

    function saveSystem() {
        localStorage.setItem('oba_data', JSON.stringify({
            products: state.products,
            seeds: state.seeds,
            shops: state.shops
        }));
        localStorage.setItem('oba_users', JSON.stringify(state.users));
    }

    function checkSession() {
        const activePhone = localStorage.getItem('oba_active_user');
        if(activePhone) {
            // Find user in database
            const user = state.users.find(u => u.phone === activePhone);
            if(user) {
                currentUser = user;
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'flex';
                updatePointsDisplay();
                updateCartCount();
                navigate('home');
            } else {
                localStorage.removeItem('oba_active_user');
                alert("Hesabƒ±nƒ±z sistemd…ôn silinib.");
                document.getElementById('auth-container').style.display = 'flex';
            }
        } else {
            document.getElementById('auth-container').style.display = 'flex';
        }
    }

    function logout() {
        currentUser = null;
        localStorage.removeItem('oba_active_user');
        document.getElementById('app-container').style.display = 'none';
        document.getElementById('auth-container').style.display = 'flex';
        // Clear inputs
        document.getElementById('reg-name').value = '';
        document.getElementById('reg-surname').value = '';
        document.getElementById('reg-phone').value = '';
        document.getElementById('reg-pass').value = '';
    }

    /* --- AUTHENTICATION --- */
    function formatPhone(input) {
        let val = input.value.replace(/\D/g, '');
        if (val.startsWith('994')) val = '+' + val;
        else if (val.startsWith('0')) val = '+994' + val.substring(1);
        else if (val.length > 0 && !val.startsWith('+')) val = '+994' + val;
        
        input.value = val;
    }

    function registerUser() {
        const name = document.getElementById('reg-name').value.trim();
        const surname = document.getElementById('reg-surname').value.trim();
        const phone = document.getElementById('reg-phone').value.trim();
        const pass = document.getElementById('reg-pass').value.trim();

        if(!phone || !pass) return alert("N√∂mr…ô v…ô ≈ûifr…ô m√ºtl…ôqdir!");

        // Validate Phone (AZ mobile)
        const azPhoneRegex = /^(?:\+994)(50|51|55|70|77|99|10)[0-9]{7}$/;
        if(!azPhoneRegex.test(phone)) {
            return alert("Z…ôhm…ôt olmasa d√ºzg√ºn Az…ôrbaycan n√∂mr…ôsi daxil edin (+994...)");
        }

        // Check exists
        let user = state.users.find(u => u.phone === phone);
        if(user) {
            // User exists, try login
            if(user.password === pass) {
                currentUser = user;
                localStorage.setItem('oba_active_user', phone);
                checkSession();
                return;
            } else {
                return alert("Bu n√∂mr…ô artƒ±q qeydiyyatdan ke√ßib. ≈ûifr…ô yanlƒ±≈üdƒ±r!");
            }
        }

        // New Registration
        if(!name || !surname) return alert("Yeni qeydiyyat √º√ß√ºn Ad v…ô Soyad daxil edin.");

        user = {
            id: Date.now(),
            name: name,
            surname: surname,
            phone: phone,
            password: pass,
            balance: 100, 
            isBanned: false, 
            isGameBanned: false, 
            farmSlots: Array(9).fill(null).map(() => ({ status: 0, product: null, progress: 0 })),
            favorites: [],
            purchaseHistory: [] // To track stats [{productId: 1, count: 5}, ...]
        };
        state.users.push(user);
        saveSystem();

        // Login
        currentUser = user;
        localStorage.setItem('oba_active_user', phone);
        checkSession();
    }

    /* --- USER UI LOGIC --- */
    function updatePointsDisplay() {
        if(currentUser) document.getElementById('header-points').innerText = currentUser.balance;
    }

    function showToast(message) {
        const toast = document.getElementById('toast');
        toast.innerText = message;
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
    }

    function navigate(pageName) {
        activeTab = pageName;
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById(`nav-${pageName}`).classList.add('active');

        const cartBtn = document.getElementById('cart-float');
        cartBtn.style.display = (pageName === 'shop') ? 'flex' : 'none';

        if(pageName === 'home') renderHome();
        else if(pageName === 'shop') renderShop('Hamƒ±sƒ±');
        else if(pageName === 'game') renderGame();
        else if(pageName === 'profile') renderProfile();
    }

    /* --- RENDER HOME (Personalized Offers) --- */
    function renderHome() {
        const container = document.getElementById('main-content');
        
        let dynamicNotifs = [
            "G√ºn√ºn f√ºrs…ôti: Banan alana 15 Oba Points!",
            "Yeni kampaniya: ƒ∞√ßkil…ôrd…ô 1+1 f√ºrs…ôti!"
        ];
        
        // 1. Favorites Notification
        const favProducts = state.products.filter(p => currentUser.favorites.includes(p.id));
        if (favProducts.length > 0) {
            favProducts.forEach(p => {
                if(p.price > p.discount) {
                    dynamicNotifs.unshift(`‚ù§Ô∏è Sevimli m…ôhsulunuz "${p.name}" endirimd…ôdir!`);
                }
            });
        }

        // 2. Most Purchased Notification (Smart Logic)
        const mostPurchased = getMostPurchasedProducts(currentUser);
        mostPurchased.forEach(mp => {
             // If product is on discount AND user buys it often
             if(mp.price > mp.discount) {
                 dynamicNotifs.unshift(`üî• Sizin sevimli m…ôhsulunuz "${mp.name}" endirimd…ôdir, almaƒüa t…ôl…ôsin!`);
             }
        });

        const displayNotifs = dynamicNotifs.slice(0, 5); // Show max 5

        const randomProduct = state.products[Math.floor(Math.random() * state.products.length)];
        let xpPrice = Math.floor(Math.random() * (600 - 300 + 1)) + 300;
        xpPrice = Math.round(xpPrice / 10) * 10;

        container.innerHTML = `
            <div class="section-title">üîî T…ôklifl…ôr</div>
            <div class="notif-container">
                ${displayNotifs.map(n => {
                    let className = 'notif-card';
                    let icon = 'üéÅ';
                    if(n.includes('‚ù§Ô∏è')) { className += ' fav-notif'; icon = '‚ù§Ô∏è'; }
                    if(n.includes('t…ôl…ôsin')) { className += ' hot-notif'; icon = '‚ö°'; }
                    return `
                    <div class="${className}">
                        <span style="font-size:1.5rem;">${icon}</span>
                        <div>${n}</div>
                    </div>
                `}).join('')}
            </div>
            
            <div class="section-title">üî• G√ºn√ºn T…ôklifi (XP il…ô al)</div>
            <div class="product-item" style="border: 2px solid var(--accent); background: #fffbe6;">
                <span style="font-size: 50px;">${randomProduct.icon}</span>
                <h3>${randomProduct.name}</h3>
                <p>Bazar qiym…ôti: <span class="old-price">${randomProduct.price} ‚Çº</span></p>
                <p style="font-weight:bold; color: var(--primary);">Sad…ôc…ô: ${xpPrice} XP</p>
                <button class="add-btn" onclick="buyDeal(${xpPrice}, '${randomProduct.name}')">ƒ∞ndi Al (${xpPrice} XP)</button>
            </div>
        `;
    }

    function buyDeal(price, name) {
        if(currentUser.balance >= price) {
            currentUser.balance -= price;
            saveSystem(); 
            updatePointsDisplay();
            showToast(`T…ôbrikl…ôr! ${name} alƒ±ndƒ±.`);
        } else {
            showToast("Balansƒ±nƒ±zda kifay…ôt q…ôd…ôr XP yoxdur!");
        }
    }

    // Analytic Helper
    function getMostPurchasedProducts(user) {
        if(!user.purchaseHistory || user.purchaseHistory.length === 0) return [];
        // Sort by count desc
        const sorted = [...user.purchaseHistory].sort((a,b) => b.count - a.count);
        // Get top 3 product IDs
        const topIds = sorted.slice(0,3).map(x => x.productId);
        // Map to real product objects
        return state.products.filter(p => topIds.includes(p.id));
    }

    /* --- RENDER SHOP --- */
    function renderShop(category) {
        currentCategory = category;
        const container = document.getElementById('main-content');
        const cats = ["Hamƒ±sƒ±", "≈ûirniyyat", "Quru qida", "Meyv…ô-t…ôr…ôv…ôz", "ƒ∞√ßkil…ôr", "S√ºd M…ôhsullarƒ±", "∆èt", "T…ômizlik", "Un m…ômulatlarƒ±"];
        const filtered = category === "Hamƒ±sƒ±" ? state.products : state.products.filter(p => p.cat === category);

        container.innerHTML = `
            <div class="category-scroll">
                ${cats.map(c => `<div class="cat-chip ${currentCategory===c?'active':''}" onclick="renderShop('${c}')">${c}</div>`).join('')}
            </div>
            <div class="product-grid" style="padding-bottom: 50px;">
                ${filtered.map(p => {
                    const hasDiscount = p.price > p.discount;
                    const isFav = currentUser.favorites.includes(p.id);
                    return `
                    <div class="product-item" style="${p.stock <= 0 ? 'opacity:0.6;' : ''}">
                        <button class="fav-btn" onclick="toggleFavorite(${p.id})">${isFav ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                        <div style="font-size:35px">${p.icon}</div>
                        <div style="font-weight:700; font-size:0.85rem; height:30px;">${p.name}</div>
                        <div>
                            ${hasDiscount ? `<span class="old-price">${p.price.toFixed(2)}</span>` : ''} 
                            <span class="new-price" style="${!hasDiscount ? 'color:#333' : ''}">${p.discount.toFixed(2)} ‚Çº</span>
                        </div>
                        <button class="add-btn" 
                            style="margin-top:5px; font-size:0.75rem; background: ${p.stock <= 0 ? '#999' : ''}" 
                            onclick="${p.stock > 0 ? `addToCart(${p.id})` : ''}">
                            ${p.stock > 0 ? 'S…ôb…ôt…ô At üõí' : 'Bitib ‚ùå'}
                        </button>
                    </div>
                `}).join('')}
            </div>
        `;
    }

    function toggleFavorite(id) {
        if(currentUser.favorites.includes(id)) {
            currentUser.favorites = currentUser.favorites.filter(fid => fid !== id);
        } else {
            currentUser.favorites.push(id);
            const p = state.products.find(x => x.id === id);
            if(p) showToast(`${p.name} sevimlil…ôr…ô …ôlav…ô olundu!`);
        }
        saveSystem();
        renderShop(currentCategory);
    }

    /* --- CART LOGIC --- */
    function addToCart(prodId) {
        const prod = state.products.find(p => p.id === prodId);
        if(prod.stock <= 0) return showToast("Bu m…ôhsul bitib!");

        const existing = cart.find(item => item.id === prodId);
        if(existing) {
            existing.qty++;
        } else {
            cart.push({ id: prodId, qty: 1, name: prod.name, price: prod.discount });
        }
        updateCartCount();
        showToast("S…ôb…ôt…ô …ôlav…ô olundu!");
    }

    function updateCartCount() {
        const count = cart.reduce((sum, item) => sum + item.qty, 0);
        document.getElementById('cart-count').innerText = count;
    }

    function openCartModal() {
        const modal = document.getElementById('cart-modal');
        modal.style.display = 'flex';
        renderCartItems();
    }

    function renderCartItems() {
        const container = document.getElementById('cart-items');
        if(cart.length === 0) {
            container.innerHTML = "<p style='color:#777;'>S…ôb…ôtiniz bo≈üdur</p>";
            document.getElementById('cart-total').innerText = "0.00 ‚Çº";
            return;
        }

        let total = 0;
        container.innerHTML = cart.map(item => {
            total += item.price * item.qty;
            return `
                <div class="cart-item">
                    <div style="text-align:left;">
                        <div style="font-weight:bold; font-size:14px;">${item.name}</div>
                        <div style="font-size:12px; color:#666;">${item.price.toFixed(2)} ‚Çº</div>
                    </div>
                    <div class="qty-controls">
                        <span class="qty-btn" onclick="updateCartQty(${item.id}, -1)">-</span>
                        <span style="font-size:14px; margin:0 5px;">${item.qty}</span>
                        <span class="qty-btn" onclick="updateCartQty(${item.id}, 1)">+</span>
                    </div>
                </div>
            `;
        }).join('');
        document.getElementById('cart-total').innerText = total.toFixed(2) + " ‚Çº";
    }

    function updateCartQty(id, change) {
        const item = cart.find(x => x.id === id);
        if(item) {
            item.qty += change;
            if(item.qty <= 0) {
                cart = cart.filter(x => x.id !== id);
            }
            renderCartItems();
            updateCartCount();
        }
    }

    function closeCartModal() { document.getElementById('cart-modal').style.display = 'none'; }

    function checkout() {
        if(cart.length === 0) return showToast("S…ôb…ôt bo≈üdur!");

        let error = false;
        for(let item of cart) {
            const prod = state.products.find(p => p.id === item.id);
            if(!prod || prod.stock < item.qty) {
                alert(`"${item.name}" m…ôhsulundan stokda kifay…ôt q…ôd…ôr yoxdur! (Qalƒ±q: ${prod ? prod.stock : 0})`);
                error = true;
                break;
            }
        }

        if(!error) {
            cart.forEach(item => {
                const prod = state.products.find(p => p.id === item.id);
                if(prod) prod.stock -= item.qty;
                
                // Track Statistics
                if(!currentUser.purchaseHistory) currentUser.purchaseHistory = [];
                const hist = currentUser.purchaseHistory.find(h => h.productId === item.id);
                if(hist) hist.count += item.qty;
                else currentUser.purchaseHistory.push({ productId: item.id, count: item.qty });
            });

            saveSystem(); 
            cart = [];
            updateCartCount();
            closeCartModal();
            showToast("Sifari≈ü uƒüurla tamamlandƒ±! ‚úÖ");
            
            if(activeTab === 'shop') renderShop(currentCategory);
        }
    }

    /* --- GAME LOGIC --- */
    function renderGame() {
        if(currentUser.isGameBanned) {
            const container = document.getElementById('main-content');
            container.innerHTML = `
                <div style="text-align:center; padding:50px; color:var(--danger);">
                    <h1>üö´</h1>
                    <h3>Giri≈ü Qadaƒüandƒ±r</h3>
                    <p>Sizin Ferma Oyununa giri≈üiniz Admin t…ôr…ôfind…ôn m…ôhdudla≈üdƒ±rƒ±lƒ±b.</p>
                </div>
            `;
            return;
        }

        const container = document.getElementById('main-content');
        container.innerHTML = `
            <div style="background: var(--primary); color: white; padding: 15px; border-radius: 15px; text-align: center;">
                <h2 style="margin:0;">Endirim Ferma</h2>
                <p style="font-size: 12px;">M…ôhsul …ôk, Oba Points qazan!</p>
            </div>
            <div class="farm-grid" id="farm-grid"></div>
        `;
        updateGrid();
    }

    function updateGrid() {
        const grid = document.getElementById('farm-grid');
        if(!grid) return;
        grid.innerHTML = '';
        currentUser.farmSlots.forEach((slot, i) => {
            const div = document.createElement('div');
            div.className = `farm-slot ${slot.status === 2 ? 'ready' : ''}`;
            div.onclick = () => handleSlotClick(i);
            if(slot.status === 0) div.innerHTML = "üü´";
            else if(slot.status === 1) div.innerHTML = `<span>${slot.product.icon}</span><div class="progress-container"><div class="progress-fill" id="progress-${i}" style="width:${slot.progress}%"></div></div>`;
            else if(slot.status === 2) div.innerHTML = `<span>${slot.product.icon}</span><b style="font-size:10px; color:#006230;">YIƒû!</b>`;
            grid.appendChild(div);
        });
    }

    function handleSlotClick(i) {
        const slot = currentUser.farmSlots[i];
        if(slot.status === 0) openPlantMenu(i);
        else if(slot.status === 2) harvest(i);
    }

    function openPlantMenu(i) {
        if(currentUser.balance < 10) return showToast("Xal √ßatmƒ±r!");
        selectedSlot = i;
        const modal = document.getElementById('seed-modal');
        const list = document.getElementById('seed-list');
        modal.style.display = 'flex';
        list.innerHTML = state.seeds.map(s => `
            <div class="seed-option" onclick="plant(${s.id})">
                <span>${s.icon} ${s.name} (${s.time} san)</span>
                <span style="color:var(--secondary);">+${s.reward} XP</span>
            </div>
        `).join('');
    }

    function closeModal() { document.getElementById('seed-modal').style.display = 'none'; }

    function plant(seedId) {
        const seed = state.seeds.find(s => s.id === seedId);
        const i = selectedSlot;
        currentUser.balance -= 10;
        updatePointsDisplay();
        currentUser.farmSlots[i] = { status: 1, product: seed, progress: 0, startTime: Date.now(), endTime: Date.now() + (seed.time*1000) };
        saveSystem();
        closeModal();
        updateGrid();
    }

    function updateUIProgress() {
        if(!currentUser || currentUser.isGameBanned) return;
        currentUser.farmSlots.forEach((slot, i) => {
            if(slot.status === 1) {
                let percent = ((Date.now() - slot.startTime) / (slot.endTime - slot.startTime)) * 100;
                if(percent >= 100) { slot.status = 2; updateGrid(); }
                else {
                    slot.progress = percent;
                    const bar = document.getElementById(`progress-${i}`);
                    if(bar) bar.style.width = percent + "%";
                }
            }
        });
    }

    function harvest(i) {
        currentUser.balance += parseInt(currentUser.farmSlots[i].product.reward);
        updatePointsDisplay();
        showToast(`Yƒ±ƒüƒ±ldƒ±! +${currentUser.farmSlots[i].product.reward} XP`);
        currentUser.farmSlots[i] = { status: 0, product: null, progress: 0 };
        saveSystem();
        updateGrid();
    }

    function renderProfile() {
        const container = document.getElementById('main-content');
        container.innerHTML = `
            <div style="text-align:center; padding:20px;">
                <div style="width:70px; height:70px; background:#ddd; border-radius:50%; margin:0 auto; display:flex; align-items:center; justify-content:center; font-size:30px;">üë§</div>
                <h3>${currentUser.name} ${currentUser.surname}</h3>
                <p style="color:var(--primary); font-weight:bold;">${currentUser.phone}</p>
                <div style="text-align:left; background:white; padding:15px; border-radius:10px; margin-top:20px;">
                    <p>üí≥ Balans: ${currentUser.balance} XP</p>
                </div>
                <button class="add-btn" style="background:#e74c3c; margin-top:20px;" onclick="logout()">√áƒ±xƒ±≈ü</button>
                <button class="add-btn" style="background:#333; margin-top:10px;" onclick="openAdminPanel()">üîß Admin Paneli</button>
            </div>
        `;
    }

    /* --- ADMIN PANEL --- */
    function openAdminPanel() {
        const pass = prompt("Admin ≈ûifr…ôsi (Demo: admin):");
        if(pass === 'admin') {
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('admin-container').style.display = 'flex';
            adminNav('dashboard', document.querySelector('.admin-menu-item.active'));
        } else {
            alert("Yanlƒ±≈ü ≈üifr…ô!");
        }
    }

    function exitAdmin() {
        document.getElementById('admin-container').style.display = 'none';
        document.getElementById('app-container').style.display = 'flex';
        renderHome();
    }

    function adminNav(page, el) {
        document.querySelectorAll('.admin-menu-item').forEach(e => e.classList.remove('active'));
        if(el) el.classList.add('active');

        const title = document.getElementById('admin-page-title');
        const view = document.getElementById('admin-view-port');

        if (page === 'dashboard') {
            title.innerText = "Dashboard";
            const activeDiscounts = state.products.filter(p => p.price > p.discount).length;
            view.innerHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ƒ∞stifad…ô√ßil…ôr</div>
                        <div class="stat-val">${state.users.length}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Toplam Stok</div>
                        <div class="stat-val">${state.products.reduce((acc,p) => acc + p.stock, 0)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Aktiv Endiriml…ôr (Real)</div>
                        <div class="stat-val">${activeDiscounts}</div>
                    </div>
                </div>
                <div class="chart-container">
                    <h3>Satƒ±≈ü Statistikasƒ±</h3>
                    <div style="height: 220px; position:relative;">
                        <canvas id="revChart"></canvas>
                    </div>
                </div>
            `;
            setTimeout(initChart, 100);
        }
        else if (page === 'shops') {
            title.innerText = "Maƒüaza ƒ∞dar…ô√ßiliyi";
            let shopRows = state.shops.map(shop => `
                <tr>
                    <td>#${shop.id}</td>
                    <td>${shop.name}</td>
                    <td>${shop.cat}</td>
                    <td>‚≠ê ${shop.rating}</td>
                    <td>
                        <div style="width:100px; height:8px; background:#ddd; border-radius:5px; display:inline-block; margin-right:5px;">
                            <div style="width:${shop.forecast}%; height:100%; background:${shop.forecast>90?'#2ECC71':'#F2C94C'}; border-radius:5px;"></div>
                        </div>
                        <small>${shop.forecast}%</small>
                    </td>
                </tr>
            `).join('');

            view.innerHTML = `
                <div style="display:flex; justify-content:flex-end; margin-bottom:15px;">
                    <button class="add-btn" style="width:auto;" onclick="openAddShopModal()">+ Yeni Maƒüaza</button>
                </div>
                <table class="admin-table">
                    <thead><tr><th>ID</th><th>Maƒüaza</th><th>Kateqoriya</th><th>Reytinq</th><th>Satƒ±≈ü Proqnozu</th></tr></thead>
                    <tbody>${shopRows}</tbody>
                </table>
            `;
        }
        else if (page === 'users') {
            title.innerText = "ƒ∞stifad…ô√ßil…ôr ƒ∞dar…ô√ßiliyi";
            let userRows = state.users.map(u => `
                <tr class="${u.isGameBanned ? 'banned-row' : ''}" onclick="viewUserDetails(${u.id})">
                    <td>${u.name} ${u.surname}</td>
                    <td>${u.phone}</td>
                    <td>${u.password}</td>
                    <td>${u.balance} Pts</td>
                    <td onclick="event.stopPropagation()">
                        <button class="btn-sm ${u.isGameBanned ? 'btn-green' : 'btn-red'}" onclick="toggleUserBan(${u.id})">
                            ${u.isGameBanned ? 'Bani A√ß' : 'Banla (Ferma)'}
                        </button>
                        <button class="btn-sm btn-red" style="margin-left:5px;" onclick="deleteUser(${u.id})">Sil</button>
                    </td>
                </tr>
            `).join('');

            view.innerHTML = `
                <p style="font-size:12px; color:#666;">ƒ∞stifad…ô√ßinin detallarƒ±na baxmaq √º√ß√ºn s…ôtr…ô klikl…ôyin.</p>
                <table class="admin-table">
                    <thead><tr><th>Ad Soyad</th><th>N√∂mr…ô</th><th>≈ûifr…ô</th><th>Balans</th><th>∆èm…ôliyyat</th></tr></thead>
                    <tbody>${userRows}</tbody>
                </table>
            `;
        }
        else if (page === 'products') {
            title.innerText = "M…ôhsul ƒ∞dar…ô√ßiliyi";
            let productRows = state.products.map(p => `
                <tr onclick="viewProductDetails(${p.id})">
                    <td>${p.icon} ${p.name}</td>
                    <td>${p.price.toFixed(2)} ‚Çº</td>
                    <td style="color:var(--danger); font-weight:bold; text-align:center;">
                        ${p.price > p.discount ? p.discount.toFixed(2) + ' ‚Çº' : '-'}
                    </td>
                    <td>${p.cat}</td>
                    <td style="color:${p.stock<5?'red':'black'}">${p.stock}</td>
                </tr>
            `).join('');

            view.innerHTML = `
                <div style="margin-bottom:20px;">
                    <button class="add-btn" style="width:100%;" onclick="openAdminProductModal()">+ Yeni M…ôhsul ∆èlav…ô Et</button>
                </div>
                <div style="background:white; border-radius:10px; padding:10px;">
                    <table class="admin-table">
                        <thead><tr><th>Ad</th><th>Qiym…ôt</th><th style="text-align:center;">Endirimli</th><th>Kateqoriya</th><th>Stok</th></tr></thead>
                        <tbody>${productRows}</tbody>
                    </table>
                </div>
            `;
        }
        else if (page === 'games') {
            title.innerText = "Oyun T…ônziml…ôm…ôl…ôri (Ferma)";
            
            let seedRows = state.seeds.map((s, idx) => `
                <tr>
                    <td>${s.icon}</td>
                    <td>${s.name}</td>
                    <td>${s.time} san</td>
                    <td>${s.reward} XP</td>
                    <td><button class="btn-sm btn-red" onclick="deleteSeed(${s.id})">Sil</button></td>
                </tr>
            `).join('');

            view.innerHTML = `
                <button class="add-btn" style="width:100%; margin-bottom:20px;" onclick="openAddSeedModal()">+ YENƒ∞ M∆èHSUL YARAT (TOXUM)</button>
                
                <div class="stat-card">
                    <h4>M√∂vcud Bitkil…ôr</h4>
                    <table class="admin-table">
                        <thead><tr><th>ƒ∞kon</th><th>Ad</th><th>M√ºdd…ôt</th><th>M√ºkafat</th><th>∆èm…ôliyyat</th></tr></thead>
                        <tbody>${seedRows}</tbody>
                    </table>
                </div>
            `;
        }
    }

    /* --- ADMIN LOGIC --- */

    function toggleUserBan(userId) {
        const u = state.users.find(x => x.id === userId);
        if(u) {
            u.isGameBanned = !u.isGameBanned;
            saveSystem();
            adminNav('users', null);
        }
    }

    function deleteUser(userId) {
        if(confirm("ƒ∞stifad…ô√ßini silm…ôk ist…ôyirsiniz? Bu …ôm…ôliyyat geri qaytarƒ±la bilm…ôz.")) {
            state.users = state.users.filter(u => u.id !== userId);
            if(currentUser && currentUser.id === userId) {
                localStorage.removeItem('oba_active_user');
                location.reload();
            }
            saveSystem();
            adminNav('users', null);
        }
    }

    // USER ANALYTICS MODAL
    function viewUserDetails(userId) {
        const u = state.users.find(x => x.id === userId);
        if(!u) return;

        const modal = document.getElementById('user-detail-modal');
        const content = document.getElementById('user-detail-content');
        modal.style.display = 'flex';

        // Calc Favorites Names
        const favNames = state.products.filter(p => u.favorites.includes(p.id)).map(p => p.name).join(', ') || "Yoxdur";
        
        // Calc Most Purchased Per Category
        let statsHtml = '';
        if(u.purchaseHistory && u.purchaseHistory.length > 0) {
            // Group by category
            let catGroups = {};
            u.purchaseHistory.forEach(h => {
                const prod = state.products.find(p => p.id === h.productId);
                if(prod) {
                    if(!catGroups[prod.cat]) catGroups[prod.cat] = [];
                    catGroups[prod.cat].push({ name: prod.name, count: h.count });
                }
            });

            // Find max in each group
            statsHtml = '<h4>Kateqoriya √ºzr…ô ∆èn √áox Alƒ±nanlar:</h4><ul style="text-align:left;">';
            for (const [cat, items] of Object.entries(catGroups)) {
                items.sort((a,b) => b.count - a.count);
                statsHtml += `<li><b>${cat}:</b> ${items[0].name} (${items[0].count} …ôd…ôd)</li>`;
            }
            statsHtml += '</ul>';
        } else {
            statsHtml = '<p>Alƒ±≈ü tarix√ß…ôsi yoxdur.</p>';
        }

        content.innerHTML = `
            <h3>${u.name} ${u.surname}</h3>
            <p>Tel: ${u.phone}</p>
            <hr>
            <div style="text-align:left; margin-bottom:15px;">
                <strong>‚ù§Ô∏è Sevimlil…ôr:</strong><br> ${favNames}
            </div>
            <div style="background:#f9f9f9; padding:10px; border-radius:10px;">
                ${statsHtml}
            </div>
            <button class="add-btn" style="background:#999; margin-top:15px;" onclick="closeUserDetail()">Baƒüla</button>
        `;
    }
    
    function closeUserDetail() { document.getElementById('user-detail-modal').style.display = 'none'; }

    // Add Shop
    function openAddShopModal() {
        document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Yeni Maƒüaza ∆èlav…ô Et";
        document.getElementById('modal-body').innerHTML = `
            <div class="form-group"><label>Maƒüaza Adƒ±</label><input id="new-shop-name" type="text" value="OBA - "></div>
            <div class="form-group"><label>Kateqoriya</label><input id="new-shop-cat" type="text" value="Market"></div>
            <button class="add-btn" onclick="saveNewShop()">∆èlav…ô Et</button>
        `;
    }

    function saveNewShop() {
        const name = document.getElementById('new-shop-name').value;
        const cat = document.getElementById('new-shop-cat').value;
        const forecast = Math.floor(Math.random() * (99 - 85) + 85); 
        state.shops.push({ id: 100 + state.shops.length + 1, name: name, cat: cat, rating: 5.0, forecast: forecast });
        saveSystem();
        closeAdminModal();
        adminNav('shops', null);
    }

    /* --- GAME & PRODUCT ADMIN --- */
    function openAddSeedModal() {
        document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = "Yeni Ferma M…ôhsulu";
        document.getElementById('modal-body').innerHTML = `
            <div class="form-group"><label>Ad</label><input type="text" id="seed-name" placeholder="M…ôs: K√∂k"></div>
            <div class="form-group"><label>Emoji</label><input type="text" id="seed-icon" placeholder="ü•ï"></div>
            <div class="form-group"><label>Yeti≈üm…ô M√ºdd…ôti (San)</label><input type="number" id="seed-time" placeholder="30"></div>
            <div class="form-group"><label>M√ºkafat (XP)</label><input type="number" id="seed-reward" placeholder="60"></div>
            <button class="add-btn" onclick="saveNewSeed()">Yadda Saxla</button>
        `;
    }

    function saveNewSeed() {
        const name = document.getElementById('seed-name').value;
        const icon = document.getElementById('seed-icon').value;
        const time = parseInt(document.getElementById('seed-time').value);
        const reward = parseInt(document.getElementById('seed-reward').value);

        if(!name || !time || !reward) return alert("B√ºt√ºn xanalarƒ± doldurun!");

        state.seeds.push({ id: Date.now(), name, icon, time, reward });
        saveSystem();
        closeAdminModal();
        adminNav('games', null);
    }

    function deleteSeed(id) {
        if(confirm("Silm…ôk ist…ôdiyiniz…ô …ôminsiniz?")) {
            state.seeds = state.seeds.filter(s => s.id !== id);
            saveSystem();
            adminNav('games', null);
        }
    }

    /* --- PRODUCT MODAL & LOGIC --- */
    let isEditingProduct = false;
    let editingProductId = null;

    function openAdminProductModal(productData = null) {
        isEditingProduct = !!productData;
        editingProductId = productData ? productData.id : null;

        document.getElementById('admin-modal').style.display = 'flex';
        document.getElementById('modal-title').innerText = isEditingProduct ? "M…ôhsulu Redakt…ô Et" : "Yeni M…ôhsul ∆èlav…ô Et";
        
        const def = productData || { name: '', cat: '≈ûirniyyat', icon: 'üç´', stock: 50, expiry: 30, price: 1.50, type: 'manual', discount: 1.50, aiTiers: [] };
        
        let aiRowsHtml = '';
        if(def.aiTiers && def.aiTiers.length > 0) {
            def.aiTiers.forEach((tier, index) => {
                aiRowsHtml += getAiTierRowHtml(index, tier.days, tier.percent);
            });
        } else {
            aiRowsHtml = getAiTierRowHtml(0, 10, 10);
        }

        const cats = ["≈ûirniyyat", "Quru qida", "Meyv…ô-t…ôr…ôv…ôz", "ƒ∞√ßkil…ôr", "S√ºd M…ôhsullarƒ±", "∆èt", "T…ômizlik", "Un m…ômulatlarƒ±"];
        
        document.getElementById('modal-body').innerHTML = `
            <div class="form-group"><label>M…ôhsul Adƒ±</label><input type="text" id="p-name" value="${def.name}"></div>
            <div class="form-group"><label>Kateqoriya</label><select id="p-cat">
                ${cats.map(c => `<option ${def.cat===c?'selected':''}>${c}</option>`).join('')}
            </select></div>
            <div class="form-group"><label>ƒ∞kon</label><input type="text" id="p-icon" value="${def.icon}"></div>
            
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="form-group"><label>Stok (Say)</label><input type="number" id="p-stock" value="${def.stock}"></div>
                <div class="form-group"><label>Son Tarix (G√ºn)</label><input type="number" id="p-expiry" value="${def.expiryDays !== undefined ? def.expiryDays : def.expiry}"></div>
            </div>

            <div class="form-group"><label>Qiym…ôt (‚Çº)</label><input type="number" id="p-price" step="0.1" value="${def.price}"></div>
            
            <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
            <h4 style="margin:5px 0 10px 0;">Endirim ƒ∞dar…ôetm…ôsi</h4>
            
            <div class="radio-group">
                <label><input type="radio" name="discType" value="manual" ${def.type==='manual'?'checked':''} onchange="toggleDiscInputs()"> Manual</label>
                <label><input type="radio" name="discType" value="ai" ${def.type==='ai'?'checked':''} onchange="toggleDiscInputs()"> AI (Avto)</label>
            </div>

            <div id="manual-inputs" style="display:${def.type==='manual'?'block':'none'}">
                <div class="form-group"><label>Endirimli Qiym…ôt (‚Çº)</label><input type="number" id="p-disc-price" step="0.1" value="${def.discount}"></div>
            </div>

            <div id="ai-inputs" style="display:${def.type==='ai'?'block':'none'}">
                <div id="ai-tiers-container">${aiRowsHtml}</div>
                <button class="btn-sm btn-green" style="width:100%; margin-top:5px;" onclick="addAiTierRow()">+ Yeni Endirim M…ôrh…ôl…ôsi</button>
            </div>

            <button class="add-btn" style="margin-top:15px;" onclick="saveProduct()">${isEditingProduct ? 'Yadda Saxla' : 'Yarat v…ô ∆èlav…ô Et'}</button>
        `;
    }

    function getAiTierRowHtml(index, days, percent) {
        return `
            <div class="ai-tier-row" id="tier-row-${index}">
                <div><label style="font-size:10px;">Bitm…ôy…ô Qalƒ±b (G√ºn)</label><input type="number" class="tier-days" value="${days}" placeholder="< G√ºn"></div>
                <div><label style="font-size:10px;">Endirim (%)</label><input type="number" class="tier-percent" value="${percent}" placeholder="%"></div>
                <button class="btn-sm btn-red" style="height:35px;" onclick="removeTierRow(${index})">X</button>
            </div>
        `;
    }
    
    function addAiTierRow() {
        const container = document.getElementById('ai-tiers-container');
        const newHtml = getAiTierRowHtml(Date.now(), 5, 20); 
        container.insertAdjacentHTML('beforeend', newHtml);
    }
    
    function removeTierRow(id) { document.getElementById(`tier-row-${id}`).remove(); }

    function toggleDiscInputs() {
        const type = document.querySelector('input[name="discType"]:checked').value;
        document.getElementById('manual-inputs').style.display = type === 'manual' ? 'block' : 'none';
        document.getElementById('ai-inputs').style.display = type === 'ai' ? 'block' : 'none';
    }

    function saveProduct() {
        const name = document.getElementById('p-name').value;
        const cat = document.getElementById('p-cat').value;
        const icon = document.getElementById('p-icon').value;
        const price = parseFloat(document.getElementById('p-price').value);
        const stock = parseInt(document.getElementById('p-stock').value);
        const expiry = parseInt(document.getElementById('p-expiry').value);
        const discType = document.querySelector('input[name="discType"]:checked').value;

        if(!name || !price) return alert("Ad v…ô Qiym…ôt m√ºtl…ôqdir!");

        let finalDiscountPrice = price;
        let aiTiers = [];

        if (discType === 'manual') {
            const manualDisc = parseFloat(document.getElementById('p-disc-price').value);
            if(manualDisc === price) return alert("Endirimli qiym…ôt …ôsas qiym…ôtl…ô eyni ola bilm…ôz!");
            if(manualDisc) finalDiscountPrice = manualDisc;
        } else {
            const rows = document.querySelectorAll('.ai-tier-row');
            let prevDays = Infinity;
            for(let row of rows) {
                const days = parseInt(row.querySelector('.tier-days').value);
                const percent = parseInt(row.querySelector('.tier-percent').value);
                if(days >= prevDays) return alert(`AI x…ôtasƒ±: G√ºnl…ôr azalan sƒ±ra il…ô olmalƒ±dƒ±r! (${days} < ${prevDays} olmalƒ±)`);
                prevDays = days;
                aiTiers.push({ days, percent });
            }
            let appliedPercent = 0;
            for (let tier of aiTiers) {
                if(expiry < tier.days) appliedPercent = tier.percent; 
            }
            finalDiscountPrice = price - (price * (appliedPercent / 100));
        }

        const productObj = {
            id: isEditingProduct ? editingProductId : Date.now(),
            name, cat, price, 
            discount: finalDiscountPrice,
            pts: 5, icon, 
            stock, expiryDays: expiry,
            type: discType,
            aiTiers: aiTiers
        };

        if(isEditingProduct) {
            const idx = state.products.findIndex(p => p.id === editingProductId);
            if(idx !== -1) {
                state.products[idx] = { ...state.products[idx], ...productObj };
            }
        } else {
            state.products.push(productObj);
        }

        saveSystem();
        closeAdminModal();
        adminNav('products', null);
    }

    function viewProductDetails(id) {
        const p = state.products.find(x => x.id === id);
        if(!p) return;
        const modal = document.getElementById('product-detail-modal');
        const content = document.getElementById('product-detail-content');
        modal.style.display = 'flex';
        
        let aiInfo = '';
        if(p.type === 'ai' && p.aiTiers.length) {
            aiInfo = `<div style="background:#e8f5e9; padding:10px; border-radius:8px; margin-top:10px; text-align:left;">
                <strong>ü§ñ AI C…ôdv…ôli:</strong><br>${p.aiTiers.map(t => `‚Ä¢ < ${t.days} g√ºn: -${t.percent}%`).join('<br>')}
            </div>`;
        }

        content.innerHTML = `
            <div style="font-size:40px;">${p.icon}</div>
            <h2>${p.name}</h2>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left; margin-bottom:15px;">
                <div><strong>Kateqoriya:</strong> ${p.cat}</div>
                <div><strong>Stok:</strong> ${p.stock}</div>
                <div><strong>Qalƒ±b:</strong> ${p.expiryDays} g√ºn</div>
                <div><strong>Qiym…ôt:</strong> ${p.price} ‚Çº</div>
                <div><strong>Endirim:</strong> <span style="color:red; font-weight:bold;">${p.discount.toFixed(2)} ‚Çº</span></div>
                <div><strong>Tip:</strong> ${p.type.toUpperCase()}</div>
            </div>
            ${aiInfo}
            <div style="margin-top:20px; display:flex; flex-direction:column; gap:10px;">
                <button class="add-btn" style="background:var(--accent); color:black;" onclick="editProduct(${p.id})">Redakt…ô Et ‚úèÔ∏è</button>
                <div style="display:flex; gap:10px;">
                    <button class="add-btn" style="background:#999;" onclick="closeProductDetail()">Baƒüla</button>
                    <button class="add-btn" style="background:var(--danger);" onclick="deleteProduct(${p.id})">Sil üóëÔ∏è</button>
                </div>
            </div>
        `;
    }

    function editProduct(id) { closeProductDetail(); openAdminProductModal(state.products.find(x => x.id === id)); }
    function deleteProduct(id) { if(confirm("Silm…ôk?")) { state.products = state.products.filter(p => p.id !== id); saveSystem(); closeProductDetail(); adminNav('products', null); } }
    function closeProductDetail() { document.getElementById('product-detail-modal').style.display = 'none'; }
    function closeAdminModal() { document.getElementById('admin-modal').style.display = 'none'; }

    // Chart
    function initChart() {
        const ctx = document.getElementById('revChart');
        if(ctx) {
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['B.E', '√á.A', '√á', 'C.A', 'C', '≈û', 'B'],
                    datasets: [{
                        label: 'G…ôlir (AZN)',
                        data: [1200, 1900, 3000, 500, 2000, 3240, 3500],
                        borderColor: '#006230',
                        backgroundColor: 'rgba(0, 98, 48, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { 
                    responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }
                }
            });
        }
    }
</script>
</body>
</html>
</script>
</body>

</html>
